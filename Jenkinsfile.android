/*
 * Phonetics Learning App - Android Build Pipeline
 * React Native Architecture
 */

pipeline {
    agent any

    options {
        timeout(time: 2, unit: 'HOURS')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    environment {
        PROJECT_NAME = "phonetics-app-android"
        MOBILE_DIR = "react-native-mobile"
        BUILD_TYPE = "release"
        OUTPUT_DIR = "android/app/build/outputs"
        ANDROID_HOME = "${HOME}/android-sdk"
        JAVA_HOME = "/usr/lib/jvm/java-17-openjdk-amd64"
        NODE_VERSION = "18"
        GRADLE_USER_HOME = "${WORKSPACE}/gradle_cache"
        PATH = "${JAVA_HOME}/bin:${HOME}/android-sdk/cmdline-tools/latest/bin:${HOME}/android-sdk/platform-tools:${env.PATH}"
    }

    triggers {
        pollSCM('H/5 * * * *')
    }

    stages {
        stage('Pipeline Info') {
            steps {
                echo "=== Android Build Pipeline ==="
                echo "Project: ${PROJECT_NAME}"
                echo "Branch: ${env.BRANCH_NAME}"
                echo "Build: ${env.BUILD_NUMBER}"
                sh '''
                    pwd
                    ls -la react-native-mobile/ || echo "react-native-mobile/ not found"
                '''
            }
        }

        stage('Checkout') {
            steps {
                echo '=== Checking out code ==='
                checkout scm
            }
        }

        stage('Setup Node.js') {
            steps {
                echo '=== Setting up Node.js ==='
                sh '''
                    # Install Node.js if not present
                    if ! command -v node &> /dev/null || ! node --version | grep -q "v18"; then
                        echo "Installing Node.js 18..."
                        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
                        sudo apt-get install -y nodejs
                    fi
                    
                    echo "Node version: $(node --version)"
                    echo "npm version: $(npm --version)"
                '''
            }
        }

        stage('Setup Android SDK') {
            steps {
                echo '=== Setting up Android SDK ==='
                sh '''
                    # Create Android SDK directory
                    ANDROID_HOME="$HOME/android-sdk"
                    mkdir -p "$ANDROID_HOME"
                    mkdir -p "$ANDROID_HOME/cmdline-tools"
                    
                    # Check if SDK is already installed
                    if [ ! -d "$ANDROID_HOME/cmdline-tools/latest" ]; then
                        echo "Downloading Android SDK Command Line Tools..."
                        CMDLINE_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
                        wget -q "$CMDLINE_TOOLS_URL" -O cmdline-tools.zip
                        unzip -q cmdline-tools.zip
                        mv cmdline-tools "$ANDROID_HOME/cmdline-tools/latest"
                        rm cmdline-tools.zip
                    else
                        echo "Android SDK already installed, skipping download"
                    fi
                    
                    # Accept SDK licenses
                    yes | sdkmanager --licenses
                    
                    # Install required SDK components
                    sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "cmdline-tools;latest"
                    
                    # Create Gradle cache directory
                    mkdir -p "${WORKSPACE}/gradle_cache"
                    
                    echo "Android SDK setup complete"
                '''
            }
        }

        stage('Setup JDK') {
            steps {
                echo '=== Setting up JDK 17 ==='
                sh '''
                    # Install OpenJDK 17 if not already installed
                    if ! command -v java &> /dev/null || ! java -version 2>&1 | grep -q "17."; then
                        echo "Installing OpenJDK 17..."
                        sudo apt-get update -qq
                        sudo apt-get install -y -qq openjdk-17-jdk
                    else
                        echo "OpenJDK 17 already installed"
                    fi
                    
                    # Set JAVA_HOME and update PATH
                    export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
                    export PATH="$JAVA_HOME/bin:$PATH"
                    
                    echo "JAVA_HOME: $JAVA_HOME"
                    echo "Java version:"
                    java -version
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${MOBILE_DIR}") {
                    echo '=== Installing npm dependencies ==='
                    sh '''
                        npm ci
                        echo "Dependencies installed successfully"
                    '''
                }
            }
        }

        stage('Validate Dependencies') {
            steps {
                dir("${MOBILE_DIR}") {
                    echo '=== Validating React Native dependencies ==='
                    sh '''
                        # Check if node_modules exists
                        if [ ! -d "node_modules" ]; then
                            echo "ERROR: node_modules not found"
                            exit 1
                        fi
                        
                        # Check if package-lock.json exists
                        if [ ! -f "package-lock.json" ]; then
                            echo "ERROR: package-lock.json not found"
                            exit 1
                        fi
                        
                        echo "Dependencies validation completed"
                    '''
                }
            }
        }

        stage('Lint Code') {
            steps {
                dir("${MOBILE_DIR}") {
                    echo '=== Running ESLint ==='
                    sh '''
                        npm run lint || echo "WARNING: Linting found issues"
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir("${MOBILE_DIR}") {
                    echo '=== Running Jest tests ==='
                    sh '''
                        npm test -- --ci --coverage || echo "WARNING: Tests failed"
                    '''
                }
            }
        }

        stage('Build APK') {
            steps {
                retry(2) {
                    dir("${MOBILE_DIR}/android") {
                        echo '=== Building Android APK ==='
                        sh '''
                            echo "=== DEBUG INFO ==="
                            echo "Node: $(node --version)"
                            echo "npm: $(npm --version)"
                            echo "Android SDK: $ANDROID_HOME"
                            echo "Java: $(java -version 2>&1 | head -1)"
                            echo "PATH: $PATH"
                            echo "=================="
                            
                            # Ensure gradlew is executable
                            chmod +x gradlew
                            
                            # Clean previous builds
                            ./gradlew clean
                            
                            # Generate autolinking configuration (RN 0.76 requirement)
                            echo "Generating autolinking configuration..."
                            mkdir -p build/generated/autolinking
                            cd ..
                            npx react-native config || echo "Config command completed"
                            cd android
                            
                            # Build release APK
                            ./gradlew assembleRelease --no-daemon --stacktrace
                            
                            echo "APK files created:"
                            ls -lh app/build/outputs/apk/release/
                        '''
                    }
                }
            }
        }

        stage('Build AAB') {
            steps {
                retry(2) {
                    dir("${MOBILE_DIR}/android") {
                        echo '=== Building Android App Bundle ==='
                        sh '''
                            # Ensure gradlew is executable
                            chmod +x gradlew
                            
                            # Build release AAB
                            ./gradlew bundleRelease --no-daemon --stacktrace
                            
                            echo "AAB file created:"
                            ls -lh app/build/outputs/bundle/release/
                        '''
                    }
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                echo '=== Archiving build artifacts ==='
                dir("${MOBILE_DIR}") {
                    sh '''
                        mkdir -p ../artifacts/android
                        cp android/app/build/outputs/apk/release/*.apk ../artifacts/android/ || true
                        cp android/app/build/outputs/bundle/release/*.aab ../artifacts/android/ || true
                        echo "Artifacts:"
                        ls -lh ../artifacts/android/
                    '''
                }
                archiveArtifacts artifacts: 'artifacts/android/*.apk, artifacts/android/*.aab', allowEmptyArchive: false
            }
        }
    }

    post {
        always {
            echo '=== Collecting Reports ==='
        }

        success {
            echo '=== âœ… Android Build Completed Successfully ==='
            sh '''
                cat > build-status-android.txt << EOF
Build Status: SUCCESS
Platform: Android (React Native)
Build Number: ${BUILD_NUMBER}
Branch: ${BRANCH_NAME}
Timestamp: $(date)
Artifacts: APK, AAB
EOF
                cat build-status-android.txt
            '''
        }

        failure {
            echo '=== âŒ Android Build Failed ==='
            sh '''
                cat > build-status-android.txt << EOF
Build Status: FAILURE
Platform: Android (React Native)
Build Number: ${BUILD_NUMBER}
Branch: ${BRANCH_NAME}
Timestamp: $(date)
EOF
                cat build-status-android.txt
            '''
        }

        cleanup {
            echo '=== Cleaning Up ==='
            sh '''
                cd react-native-mobile/android
                chmod +x gradlew || true
                ./gradlew clean || true
            '''
        }
    }
}