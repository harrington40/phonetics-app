/*
 * Phonetics Learning App - Web Build Pipeline
 * React Web Application
 * 
 * NOTE: The main Jenkinsfile now handles web builds.
 * This pipeline is kept for standalone web-only builds if needed.
 */

pipeline {
    agent any

    options {
        timeout(time: 1, unit: 'HOURS')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    environment {
        PROJECT_NAME = "phonetics-app-web"
        WEB_DIR = "react-web"
        NODE_VERSION = "18"
        BUILD_TYPE = "production"
        WEB_OUTPUT = "dist"
    }

    triggers {
        pollSCM('H/5 * * * *')
    }

    stages {
        stage('Pipeline Info') {
            steps {
                echo "=== Web Build Pipeline ==="
                echo "Project: ${PROJECT_NAME}"
                echo "Branch: ${env.BRANCH_NAME}"
                echo "Build: ${env.BUILD_NUMBER}"
                sh '''
                    pwd
                    ls -la react-web/
                '''
            }
        }

        stage('Checkout') {
            steps {
                echo '=== Checking out code ==='
                checkout scm
            }
        }

        stage('Setup Node.js') {
            steps {
                echo '=== Setting up Node.js ==='
                sh '''
                    # Check Node.js version
                    if ! command -v node &> /dev/null || ! node --version | grep -q "v18"; then
                        echo "Installing Node.js 18..."
                        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
                        sudo apt-get install -y nodejs
                    fi
                    
                    echo "Node version: $(node --version)"
                    echo "npm version: $(npm --version)"
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${WEB_DIR}") {
                    echo '=== Installing npm dependencies ==='
                    sh '''
                        npm ci
                        echo "Dependencies installed"
                    '''
                }
            }
        }

        stage('Lint Code') {
            steps {
                dir("${WEB_DIR}") {
                    echo '=== Running ESLint ==='
                    sh '''
                        npm run lint || echo "WARNING: Linting found issues"
                    '''
                }
            }
        }

        stage('Run Tests') {
            steps {
                dir("${WEB_DIR}") {
                    echo '=== Running tests ==='
                    sh '''
                        npm test -- --run || echo "WARNING: Tests failed"
                    '''
                }
            }
        }

        stage('Build Web') {
            steps {
                dir("${WEB_DIR}") {
                    echo '=== Building React Web App ==='
                    sh '''
                        # Build production bundle
                        npm run build
                        
                        echo "Web build completed:"
                        ls -lh dist/
                        
                        # Show build size
                        du -sh dist/
                    '''
                }
            }
        }

        stage('Optimize Web Build') {
            steps {
                dir("${WEB_DIR}/dist") {
                    echo '=== Optimizing web assets ==='
                    sh '''
                        # Vite already optimizes the build
                        echo "Build size:"
                        du -sh .
                        
                        echo "Web assets ready for deployment"
                    '''
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                echo '=== Archiving build artifacts ==='
                dir("${WEB_DIR}") {
                    sh '''
                        mkdir -p ../artifacts/web
                        cp -r dist/* ../artifacts/web/
                        
                        # Create tarball for easy deployment
                        cd ../artifacts
                        tar -czf web-build-${BUILD_NUMBER}.tar.gz web/
                        
                        echo "Artifacts:"
                        ls -lh ../artifacts/
                    '''
                }
                archiveArtifacts artifacts: 'artifacts/web-build-*.tar.gz', allowEmptyArchive: false
            }
        }

        stage('Deploy to Firebase Hosting') {
            when {
                branch 'main'
            }
            steps {
                dir("${FLUTTER_DIR}") {
                    echo '=== Deploying to Firebase Hosting ==='
                    sh '''
                        # Uncomment when Firebase CLI is configured
                        # firebase deploy --only hosting
                        
                        echo "Note: Firebase Hosting deployment commented out. Configure to enable."
                    '''
                }
            }
        }

        stage('Deploy to Web Server') {
            when {
                branch 'main'
            }
            steps {
                echo '=== Deploying to Web Server ==='
                sh '''
                    # Example: Deploy to nginx or Apache
                    # rsync -avz artifacts/web/ user@server:/var/www/phonetics-app/
                    
                    # Or use SCP
                    # scp -r artifacts/web/* user@server:/var/www/phonetics-app/
                    
                    echo "Note: Web server deployment commented out. Configure to enable."
                '''
            }
        }

        stage('Health Check') {
            when {
                branch 'main'
            }
            steps {
                echo '=== Performing deployment health check ==='
                sh '''
                    # Check if deployed site is accessible
                    # curl -f https://phonetics-app.example.com/ || echo "WARNING: Site not accessible"
                    
                    echo "Health check completed"
                '''
            }
        }
    }

    post {
        always {
            echo '=== Collecting Reports ==='
            publishHTML([
                reportDir: 'react-web/dist',
                reportFiles: 'index.html',
                reportName: 'React Web Build Preview',
                allowMissing: true
            ])
        }

        success {
            echo '=== âœ… Web Build Completed Successfully ==='
            sh '''
                cat > build-status-web.txt << EOF
Build Status: SUCCESS
Platform: Web (React)
Build Number: ${BUILD_NUMBER}
Branch: ${BRANCH_NAME}
Timestamp: $(date)
Build Size: $(du -sh react-web/dist | cut -f1)
Artifacts: web-build-${BUILD_NUMBER}.tar.gz
EOF
                cat build-status-web.txt
            '''
            archiveArtifacts artifacts: 'build-status-web.txt', allowEmptyArchive: true
        }

        failure {
            echo '=== âŒ Web Build Failed ==='
            sh '''
                cat > build-status-web.txt << EOF
Build Status: FAILURE
Platform: Web (React)
Build Number: ${BUILD_NUMBER}
Branch: ${BRANCH_NAME}
Timestamp: $(date)
EOF
                cat build-status-web.txt
            '''
        }

        cleanup {
            echo '=== Cleaning Up ==='
            sh '''
                cd react-web
                rm -rf dist/ || true
            '''
        }
    }
}
